<?xml version="1.0" ?>
<project name="vimoir" default="all">
    <description>Vim speaks with Phonemic</description>
    <property name="dist.dir" location="dist"/>
    <property name="vimoir.version" value="0.1"/>

    <macrodef name="iterate">
        <attribute name="target"/>
        <sequential>
            <subant target="@{target}">
                <filelist refid="projects"/>
                <property name="tar.dir" location="${dist.dir}/${dist.name}"/>
            </subant>
        </sequential>
    </macrodef>

    <target name="all" depends="dist"
            description="Compile, build and distribute the jar files">
    </target>

    <target name="nojython" description="Setup without jython">
        <filelist id="projects" dir="src">
            <file name="netbeans/build.xml"/>
        </filelist>
    </target>

    <target name="jython"  if="jython.dir"
            description="Setup with jython">
        <filelist id="projects" dir="src">
            <file name="netbeans/build.xml"/>
            <file name="jynetbeans/build.xml"/>
        </filelist>
    </target>

    <target name="init" depends="nojython,jython"
            description="Initialize subprojetcs">
    </target>

    <target name="dist" depends="init"
            description="Distribute vimoir">
        <exec executable="/bin/sed" os="Linux" output="bin/vimoir.sh">
            <arg line="-e s/-v[0-9]\.[0-9]/-v${vimoir.version}/ bin/vimoir.sh"/>
        </exec>
        <exec executable="/bin/sed" os="Linux" output="README">
            <arg line="-e s/-v[0-9]\.[0-9]/-v${vimoir.version}/ README"/>
        </exec>
        <property name="dist.name" value="${ant.project.name}-v${vimoir.version}"/>
        <property name="tar.dir" location="${dist.dir}/${dist.name}"/>
        <delete dir="${dist.dir}"/>
        <mkdir dir="${tar.dir}"/>

        <iterate target="dist"/>

        <copy todir="${tar.dir}/conf"><fileset dir="conf"/></copy>
        <copy todir="${tar.dir}/bin"><fileset dir="bin"/></copy>
        <copy todir="${tar.dir}">
            <fileset dir="." includes="*.py,README,NEWS,LICENSE"/>
        </copy>
        <exec executable="/bin/bash" os="Linux">
            <arg line="-c 'chmod +x ${tar.dir}/bin/*.sh'"/>
        </exec>
        <exec executable="/bin/bash" os="Linux">
            <arg line="-c 'cd ${dist.dir}; tar czf ${dist.name}.tar.gz ${dist.name}'"/>
        </exec>
        <delete dir="${tar.dir}"/>
    </target>

    <target name="clean" description="clean up" >
        <delete>
            <fileset dir="." includes="*.class"/>
            <fileset dir="." includes="*.pyc"/>
        </delete>
        <delete dir="build"/>
        <delete dir="lib"/>
        <delete dir="${dist.dir}"/>
    </target>

</project>
